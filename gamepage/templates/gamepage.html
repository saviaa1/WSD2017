{% extends "base.html" %}
<meta property="og:url"           content="{{request.build_absolute_uri}}" />
<meta property="og:type"          content="website" />
<meta property="og:title"         content="{{game.name}}" />
<meta property="og:description"   content="{{game.description}}" />
<meta property="og:image"         content="{{game.image_url}}" />


{% block title %}
    <title>{{game.name}}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/gamepage.css' %}">
{% endblock %}

{% block content %}
    <h1 class="gameName">{{game.name}}</h1>
    <div class="gamepageArena">
        <div class="iframeAndScore">
            <iframe id="game_iframe"
                width="500"
                height="300"
                src="{{game.game_url}}"
                sandbox="allow-scripts allow-modals"
                <p>Your browser does not support iframes.</p>
            </iframe>
            {% if highscores %}
                <h2 class="scoreTitle">Highscores:</h2>
                <ol class="game_highscore">
                    {% for score in highscores %}
                        <li>{{score.0}}: {{score.1}}</li>
                    {% endfor %}
                </ol>
            {% endif %}
        </div>
    </div>
    {% if game.description %}
        <div class="game_description">
            <h2 class="descriptionTitle">Description:</h2>
            <div class="desc">
                <p>{{game.description}}</p>
            </div>
        </div>
    {% endif %}
    {% csrf_token %}
    <script type="text/javascript">
        var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
        const childWindow = document.getElementById("game_iframe").contentWindow;
        window.addEventListener("message", e => {
            if (e.source === childWindow ) {
                switch(e.data.messageType) {
                    case "SETTING":
                        var settingWidth = e.data.options.width;
                        var settingHeight = e.data.options.height;
                        document.getElementById("game_iframe").width = settingWidth;
                        document.getElementById("game_iframe").height = settingHeight;
                        break;
                    case "LOAD_REQUEST":
                        function csrfSafeMethod(method) {
                            // these HTTP methods do not require CSRF protection
                            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                        }
                        $.ajaxSetup({
                            beforeSend: function(xhr, settings) {
                                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                                }
                            }
                        });
                        $.ajax({
                            "type": "POST",
                            "dataType": "json",
                            "url": "./loadgamedata/",
                            success: function(data) {
                                var gameState = JSON.parse(data.gameState);
                                if (gameState == null) {
                                    var message =  {
                                        messageType: "ERROR",
                                        info: "Gamestate could not be loaded"
                                    };
                                } else {
                                    var message  = {
                                        messageType: "LOAD",
                                        gameState: gameState,
                                    };
                                }
                                document.getElementById("game_iframe").contentWindow.postMessage(message, '*');
                            },
                        });
                        break;
                    default:
                        var postdata = {
                            data: JSON.stringify(e.data),
                            dataType: 'text',
                            contentType: 'application/json; charset=utf-8',
                            csrfmiddlewaretoken: csrftoken,
                        };
                        $.post("", postdata);
                }
            }
        });

    <!-- Twitter Button -->
    </script>
    <a class="twitter-share-button"
      href="https://twitter.com/share"
      data-size="large"
      data-text="Check out this cool game {{game.name}}"
      data-url="{{ request.build_absolute_uri }}"
      data-hashtags="ASDGameStore"
      data-related="twitterapi,twitter">
    Tweet
    </a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>



{% endblock %}
